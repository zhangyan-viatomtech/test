<template>
  <div class="test">
    <div class="top">
      <div  class="btn">
        <van-button type="primary" @click="inCreateBleConnection">连接蓝牙</van-button>
        <van-button type="info" @click="inCloseBleConnection">断开连接</van-button>
      </div>
      <div style="text-align: center" v-if="connectStatus == -1">连接失败</div>
      <div style="text-align: center" v-if="connectStatus == 0">连接成功</div>
      <div style="text-align: center" v-if="connectStatus == 1">未连接</div>
    </div>
    <div class="bottom">
      <van-search
          v-model="value"
          show-action
          placeholder="请输入搜索关键词"
          @search="onSearch"
      >
        <template #action>
          <div @click="onSearch">搜索</div>
        </template>
      </van-search>
      <ul>
        <li>
          <van-button type="info" @click="monitor">监听</van-button>
          {{monitorStatus==0?'监听成功':'监听失败'}}
        </li>
        <li>
          <van-field v-model="text" label="写入文本" placeholder="请输入文本" />
          <van-button type="info" @click="writeCharacter()">写入</van-button>
          {{writeStatus==0?'写入成功':'写入失败'}}
        </li>
        <li>
          <van-button type="info" @click="read">读取</van-button>
          {{readStatus==0?'读取成功':'读取失败'}}
          <div>
            读取内容：{{readDate}}
          </div>
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('E1')">获取设备信息</van-button>
          设备信息：{{deviceInfo}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('E4')">获取电池状态</van-button>
          电池状态：{{BatteryInfo}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('E5')">开始升级固件</van-button>
          开始升级固件：{{StartFirmwareUpdate}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('E6')">固件升级数据</van-button>
          固件升级数据：{{FirmwareUpdate}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('EA')">烧录出厂信息</van-button>
          烧录出厂信息：{{FactoryConfig}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('ED')">获取主机温度</van-button>
          获取主机温度：{{Temperature}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('F1')">获取文件列表</van-button>
          获取文件列表：{{FileList}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('F2')">读文件开始</van-button>
          读文件开始：{{FileReadStart}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('F3')">读文件数据</van-button>
          读文件数据：{{FileRead}}{{fileOffset}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('F4')">读文件结束</van-button>
          开始时间：{{startTime}}
          结束时间：{{endTime}}
          速率：{{rate}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('F9')">用户列表</van-button>
          用户列表： {{ UserList }}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('01')">获取实时波形</van-button>
          获取实时波形：{{RealTimeWaveform}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('02')">获取设备运行状态</van-button>
          获取设备运行状态：{{DeviceRunStatus}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('03')">获取实时数据</van-button>
          获取实时数据：{{RealTimeData}}
        </li>
        <li>
          <van-button type="info" @click="writeCharacter('05')">停止测量</van-button>
        </li>
		<li>
		  <van-button type="info" @click="reset">恢复出厂设置</van-button>
		</li>
        <li>
          <van-button type="info" @click="writeCharacter('02')">获取设备运行参数</van-button>
          获取设备运行参数：{{DeviceRunParameters}}
        </li>

      </ul>
      <div>
        总数据：{{waveDataArray.length}}
        已展示：{{multiple}}
        时间：{{time}}
      </div>
      <div id="mainBox">
        <div id="ruler"></div>
        <div id="main" ref="main" style="height:370px">
        </div>
        <div id="bgbox">
          <canvas class="grids" id="grids" height="370"></canvas>
        </div>
      </div>
      <!--      <van-list-->
      <!--          v-model="loading"-->
      <!--          :finished="finished"-->
      <!--          finished-text="没有更多了"-->
      <!--          @load="onLoad"-->
      <!--      >-->
      <!--        <van-cell v-for="item in list" :key="item" :title="item" />-->
      <!--      </van-list>-->
    </div>
  </div>
</template>

<script>
import {mapState,mapGetters } from 'vuex'
import {connectData} from "@/assets/js/ble/public"
import { intByte16,intByte } from "@/assets/js/common"
import store from "@/store";
import {Drawing,drawgrid} from "@/assets/js/ble/canvas";
import echarts from "echarts"
import {wavelet_filter_convert} from "@/assets/js/ble/waveFiltering";
let data = '';
let timer = '';
export default {
  name: "test",
  data(){
    return{
      timer: "",
      timeout: 0,
      bleStatus:false,
      value:"",
      loading: false,
      finished: false,
      text:'',
      type:'00',
      typeNo:'00',
      len:'0000',
      data:[],
      xAxisData:[],
      yAxisData:[],
      list:[0,300,520,223,125,325,452,215,354,452,293,552,352],
      length:[0,1,2,3,4,5,6,7,8,9,10,11,12],
      Drawingdata:[],
      time:0,
	  w:0,
	  posListarr:[],
	  posList: [ 103, 224, 412, 595, 764, 931, 1110, 1287, 1463, 1639, 1806, 1986, 2171, 2358, 2531, 2717, 2904, 3082, 3257, 3432, 3610, 3783, 3958, 4137, 4323, 4500, 4679, 4854, 5032, 5190,
	   5360, 5533, 5707, 5865, 6033, 6209, 6380, 6549, 6723, 6900, 7077, 7234, 7405, 7579, 7751, 7925, 8088, 8262, 8436 ],
	   labelList: 
	   [ "Q", "Q", "Q", "Q", "Q", "Q", "Q", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", 
	   "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "N", "Q", "S", "S", "S" ]
    }
  },
  mounted() {
    let data = [-0.009868886895770394, -0.01480333034365559,-0.004934443447885197, 0,-0.0024672217239425985, 0,-0.0024672217239425985, -0.0024672217239425985,-0.007401665171827795, 0.004934443447885197, -0.0024672217239425985, 0.019737773791540788, 0.08141831689010574, 0.13569719481684292,0.1628366337802115, 0.18997607274358005, 0.22451717687877645, 0.23932050722243203, 0.25659105929003023,0.263992724461858, 0.25412383756608764, 0.24918939411820243, 0.23932050722243203, 0.20724662481117825, 0.18504162929569484, 0.1455660817126133, 0.10609053412953173, 0.06414776482250756, 0.004934443447885197, -0.04194276930702417, -0.049344434478851965, -0.03700832585913898, -0.02960666068731118, -0.02960666068731118, -0.024672217239425982, -0.02960666068731118, -0.03207388241125378, -0.024672217239425982, -0.02713943896336858, -0.02960666068731118, -0.01727055206759819, -0.01480333034365559, -0.022204995515483383, -0.009868886895770394,-0.01480333034365559, -0.02713943896336858, -0.01727055206759819,0, -0.012336108619712991, 0.012336108619712991, 0.05921332137462236, 0.08635276033799094, 0.11349219930135951, 0.12089386447318733, 0.11349219930135951, 0.09868886895770393, 0.056746099650679754, 0.004934443447885197, -0.004934443447885197, -0.0024672217239425985, -0.004934443447885197, -0.0024672217239425985, 0, 0.0024672217239425985, 0.004934443447885197, 0.004934443447885197, 0.0024672217239425985, 0.007401665171827795, 0.012336108619712991, -0.06908220827039276, -0.10115609068164652, 0.3602143716956194, 0.9178064813066467, 1.0288314588840635, 0.4391654668617825, -0.08388553861404834, -0.1702382989520393, -0.05921332137462236, -0.03207388241125378, -0.02713943896336858, -0.01480333034365559, -0.009868886895770394, -0.019737773791540788, -0.01480333034365559, -0.019737773791540788, -0.012336108619712991,0.0024672217239425985, 0, -0.01480333034365559, -0.01727055206759819, 0.004934443447885197, -0.0024672217239425985, -0.009868886895770394, -0.019737773791540788, 0.01727055206759819, 0.06414776482250756, 0.10855775585347432, 0.1455660817126133, 0.18257440757175228, 0.21711551170694865, 0.24178772894637465, 0.25412383756608764, 0.25659105929003023, 0.24918939411820243, 0.24918939411820243, 0.24178772894637465, 0.21958273343089124, 0.18997607274358005, 0.1480333034365559, 0.11842664274924472, 0.07895109516616315, 0.02713943896336858, -0.01480333034365559, -0.03207388241125378, -0.04194276930702417, -0.02960666068731118, -0.03700832585913898, -0.02713943896336858, -0.019737773791540788, -0.022204995515483383, -0.009868886895770394, -0.019737773791540788, -0.024672217239425982, -0.009868886895770394, -0.01480333034365559, -0.004934443447885197, -0.012336108619712991, -0.019737773791540788, -0.0024672217239425985,0, 0.0024672217239425985, -0.004934443447885197, -0.012336108619712991, 0.056746099650679754, 0.08881998206193353, 0.11842664274924472, 0.1258283079210725, 0.12089386447318733, 0.11595942102530211, 0.07648387344222055, 0.024672217239425982, -0.009868886895770394, -0.0024672217239425985, 0.009868886895770394, 0.01480333034365559, -0.004934443447885197, -0.007401665171827795, 0.01480333034365559, 0.007401665171827795, -0.0024672217239425985, 0.012336108619712991, 0.019737773791540788, -0.03454110413519638, -0.09868886895770393, 0.19491051619146527, 0.7919781733855741, 1.0090936850925227, 0.589665992022281, 0.02713943896336858, -0.1529677468844411, -0.06414776482250756, -0.022204995515483383, -0.02713943896336858, -0.024672217239425982, -0.01480333034365559, -0.012336108619712991, -0.024672217239425982, -0.01480333034365559, -0.024672217239425982, -0.01727055206759819, -0.007401665171827795, 0, -0.0024672217239425985, -0.004934443447885197, 0.0024672217239425985, 0.01480333034365559, -0.01480333034365559, -0.022204995515483383, 0.056746099650679754, 0.11102497757741693, 0.1480333034365559, 0.16777107722809667, 0.18997607274358005, 0.22698439860271902, 0.251656615842145, 0.2590582810139728, 0.25412383756608764, 0.24672217239425984,0.251656615842145, 0.24178772894637465,0.19984495963935048,0.1628366337802115, 0.1258283079210725, 0.08635276033799094, 0.04440999103096677,-0.007401665171827795,-0.05427887792673716, -0.056746099650679754, -0.03207388241125378, -0.039475547583081576, -0.04687721275490937,-0.024672217239425982,-0.03207388241125378, -0.024672217239425982,-0.019737773791540788,-0.02960666068731118, -0.022204995515483383,-0.012336108619712991,-0.012336108619712991,-0.007401665171827795, 0, -0.007401665171827795, 0.0024672217239425985, 0.007401665171827795,-0.007401665171827795,0.0024672217239425985,0.04194276930702417,0.06908220827039276, 0.09622164723376134,0.12829552964501512, 0.12089386447318733, 0.11102497757741693, 0.07648387344222055, 0.024672217239425982, 0,-0.012336108619712991,-0.0024672217239425985,0.012336108619712991,0.009868886895770394,0.0024672217239425985, -0.0024672217239425985, 0, -0.004934443447885197,0.009868886895770394,0.022204995515483383,-0.03207388241125378, -0.09868886895770393, 0.10362331240558913,0.6661498654645016,1.0485692326756044,0.7574370692503777,0.1406316382647281,-0.1529677468844411,-0.08388553861404834, -0.024672217239425982,-0.01727055206759819,-0.019737773791540788,-0.02960666068731118, -0.019737773791540788, -0.01727055206759819, -0.012336108619712991,-0.009868886895770394, -0.024672217239425982,-0.022204995515483383,-0.024672217239425982, -0.01480333034365559,-0.009868886895770394, -0.01480333034365559,-0.004934443447885197, 0,-0.0024672217239425985, 0,-0.0024672217239425985, -0.0024672217239425985,-0.007401665171827795, 0.004934443447885197, -0.0024672217239425985, 0.019737773791540788, 0.08141831689010574, 0.13569719481684292,0.1628366337802115, 0.18997607274358005, 0.22451717687877645, 0.23932050722243203, 0.25659105929003023,0.263992724461858, 0.25412383756608764, 0.24918939411820243, 0.23932050722243203, 0.20724662481117825, 0.18504162929569484, 0.1455660817126133, 0.10609053412953173, 0.06414776482250756, 0.004934443447885197, -0.04194276930702417, -0.049344434478851965, -0.03700832585913898, -0.02960666068731118, -0.02960666068731118, -0.024672217239425982, -0.02960666068731118, -0.03207388241125378, -0.024672217239425982, -0.02713943896336858, -0.02960666068731118, -0.01727055206759819, -0.01480333034365559, -0.022204995515483383, -0.009868886895770394,-0.01480333034365559, -0.02713943896336858, -0.01727055206759819,0, -0.012336108619712991, 0.012336108619712991, 0.05921332137462236, 0.08635276033799094, 0.11349219930135951, 0.12089386447318733, 0.11349219930135951, 0.09868886895770393, 0.056746099650679754, 0.004934443447885197, -0.004934443447885197, -0.0024672217239425985, -0.004934443447885197, -0.0024672217239425985, 0, 0.0024672217239425985, 0.004934443447885197, 0.004934443447885197, 0.0024672217239425985, 0.007401665171827795, 0.012336108619712991, -0.06908220827039276, -0.10115609068164652, 0.3602143716956194, 0.9178064813066467, 1.0288314588840635, 0.4391654668617825, -0.08388553861404834, -0.1702382989520393, -0.05921332137462236, -0.03207388241125378, -0.02713943896336858, -0.01480333034365559, -0.009868886895770394, -0.019737773791540788, -0.01480333034365559, -0.019737773791540788, -0.012336108619712991,0.0024672217239425985, 0, -0.01480333034365559, -0.01727055206759819, 0.004934443447885197, -0.0024672217239425985, -0.009868886895770394, -0.019737773791540788, 0.01727055206759819, 0.06414776482250756, 0.10855775585347432, 0.1455660817126133, 0.18257440757175228, 0.21711551170694865, 0.24178772894637465, 0.25412383756608764, 0.25659105929003023, 0.24918939411820243, 0.24918939411820243, 0.24178772894637465, 0.21958273343089124, 0.18997607274358005, 0.1480333034365559, 0.11842664274924472, 0.07895109516616315, 0.02713943896336858, -0.01480333034365559, -0.03207388241125378, -0.04194276930702417, -0.02960666068731118, -0.03700832585913898, -0.02713943896336858, -0.019737773791540788, -0.022204995515483383, -0.009868886895770394, -0.019737773791540788, -0.024672217239425982, -0.009868886895770394, -0.01480333034365559, -0.004934443447885197, -0.012336108619712991, -0.019737773791540788, -0.0024672217239425985,0, 0.0024672217239425985, -0.004934443447885197, -0.012336108619712991, 0.056746099650679754, 0.08881998206193353, 0.11842664274924472, 0.1258283079210725, 0.12089386447318733, 0.11595942102530211, 0.07648387344222055, 0.024672217239425982, -0.009868886895770394, -0.0024672217239425985, 0.009868886895770394, 0.01480333034365559, -0.004934443447885197, -0.007401665171827795, 0.01480333034365559, 0.007401665171827795, -0.0024672217239425985, 0.012336108619712991, 0.019737773791540788, -0.03454110413519638, -0.09868886895770393, 0.19491051619146527, 0.7919781733855741, 1.0090936850925227, 0.589665992022281, 0.02713943896336858, -0.1529677468844411, -0.06414776482250756, -0.022204995515483383, -0.02713943896336858, -0.024672217239425982, -0.01480333034365559, -0.012336108619712991, -0.024672217239425982, -0.01480333034365559, -0.024672217239425982, -0.01727055206759819, -0.007401665171827795, 0, -0.0024672217239425985, -0.004934443447885197, 0.0024672217239425985, 0.01480333034365559, -0.01480333034365559, -0.022204995515483383, 0.056746099650679754, 0.11102497757741693, 0.1480333034365559, 0.16777107722809667, 0.18997607274358005, 0.22698439860271902, 0.251656615842145, 0.2590582810139728, 0.25412383756608764, 0.24672217239425984,0.251656615842145, 0.24178772894637465,0.19984495963935048,0.1628366337802115, 0.1258283079210725, 0.08635276033799094, 0.04440999103096677,-0.007401665171827795,-0.05427887792673716, -0.056746099650679754, -0.03207388241125378, -0.039475547583081576, -0.04687721275490937,-0.024672217239425982,-0.03207388241125378, -0.024672217239425982,-0.019737773791540788,-0.02960666068731118, -0.022204995515483383,-0.012336108619712991,-0.012336108619712991,-0.007401665171827795, 0, -0.007401665171827795, 0.0024672217239425985, 0.007401665171827795,-0.007401665171827795,0.0024672217239425985,0.04194276930702417,0.06908220827039276, 0.09622164723376134,0.12829552964501512, 0.12089386447318733, 0.11102497757741693, 0.07648387344222055, 0.024672217239425982, 0,-0.012336108619712991,-0.0024672217239425985,0.012336108619712991,0.009868886895770394,0.0024672217239425985, -0.0024672217239425985, 0, -0.004934443447885197,0.009868886895770394,0.022204995515483383,-0.03207388241125378, -0.09868886895770393, 0.10362331240558913,0.6661498654645016,1.0485692326756044,0.7574370692503777,0.1406316382647281,-0.1529677468844411,-0.08388553861404834, -0.024672217239425982,-0.01727055206759819,-0.019737773791540788,-0.02960666068731118, -0.019737773791540788, -0.01727055206759819, -0.012336108619712991,-0.009868886895770394, -0.024672217239425982,-0.022204995515483383,-0.024672217239425982, -0.01480333034365559]
    let height = document.getElementById('main').clientHeight
    let ruler = document.getElementById('ruler')
    ruler.style.height = height/5 + 'px'
    ruler.style.top = ((height/5)*2+2) +'px'
    drawgrid()
    Drawing()
  },
  computed:{
    ...mapState({
      connectStatus: state => state.connectStatus,
      writeStatus: state => state.writeStatus,
      readStatus: state => state.readStatus,
      monitorStatus: state => state.monitorStatus,
      readDate: state => state.readDate,
      characterData: state => state.characterData,
      SERVICE_ID: state => state.SERVICE_ID,
      CHARACTERISTIC_ID: state => state.CHARACTERISTIC_ID,
      fileData: state => state.fileData,
      startTime: state => state.startTime,
      endTime: state => state.endTime,
      rate: state => state.rate,
      fileOffset: state => state.fileOffset,
      realTimeDataInfo: state=>state.realTimeDataInfo,
      waveDataArray: state=> state.waveDataArray,
      multiple: state=> state.multiple,
    }),
    ...mapGetters(["deviceInfo","BatteryInfo","StartFirmwareUpdate","FirmwareUpdate","FactoryConfig","Temperature", "FileList",
      "FileReadStart","FileRead","RealTimeWaveform","DeviceRunParameters","UserList","DeviceRunStatus","RealTimeData"]),
  },
  watch:{

  },
  methods:{
	reset(){
      let that=this
      that.$dialog.confirm({
        message: '确认恢复出厂设置，清除设备上的数据？',
        confirmButtonColor:'#fb6522'
      })
          .then(() => {
            // on confirm
            console.log('确认恢复出厂')
            that.writeCharacter('EE')
          })
          .catch(() => {
            // on cancel
          });
    },
    onSearch(){

    },
    onLoad() {
      // 异步更新数据
      // setTimeout 仅做示例，真实场景中一般为 ajax 请求
      setTimeout(() => {
        for (let i = 0; i < 10; i++) {
          this.list.push(this.list.length + 1);
        }

        // 加载状态结束
        this.loading = false;

        // 数据全部加载完成
        if (this.list.length >= 40) {
          this.finished = true;
        }
      }, 2000);
    },
    /**
     * 连接蓝牙
     */
    inCreateBleConnection(){
      connectData.openBluetooth()
    },
    /**
     * 断开蓝牙
     */
    inCloseBleConnection(){
      connectData.beforeDestroy()
    },
    /**
     * 监听
     */
    monitor(){
      connectData.monitor();
    },
    /**
     * 写入发送命令
     */
    writeCharacter(text){
      let value = ''
      if(text!=''){
        this.$store.state.cmd = text
        if(text == 'F1'){
          store.commit("setStartTime",Date.parse(new Date()))
        }
        if(text == 'F2'){
          this.data = this.FileList.fileName[0].oldName + '00000000'
        }else if(text == 'F3'){
          this.data = '00000000'
        }else if(text == 'F4'){
          store.commit("getRate",this.$store.state.fileOffset)
          // writeCurrentDate()
        }else if(text == '01' || text == '03'){
          this.data = parseInt(125).toString(16)
        }else{
          this.data = ''
        }
        value = connectData.sendCommand(text,this.type,this.data)
      }else{
        this.$store.state.cmd = this.text.substr(2,2)
        value = connectData.sendCommand(this.text,this.type,this.data)
      }
      if(text == '03'){
        let that = this
        Drawing()
        timer = setInterval(function (){
          value = connectData.sendCommand(text,that.type,that.data)
          connectData.writeCharacter(value)
          that.time++;
        },1000)
        // setTimeout(function (){
        //
        // },500)
      }else if(text == '05'){
        clearInterval(timer);
        this.$store.state.trimStop = true
        // writeCurrentDate()
      }
      connectData.writeCharacter(value)
    },
    /**
     * 读取
     */
    read(){
      connectData.read()
    },
    //屏幕常亮
    noSleep () {
      let noSleep = new this.$NoSleep();
      document.addEventListener('click',
          function enableNoSleep () {
            noSleep.enable();
            document.removeEventListener('click', enableNoSleep, false);
          },
          false);
    },
  }
}
</script>

<style scoped>
@import "../assets/css/common.css";
.biaoji{
	position: relative;
	width: 100%;
	height: 100px;
	z-index: 10;
}
.biaoji span{
	position: absolute;
	top: 0;
}
.test{
  width: 100%;
  overflow: hidden;
}
*{
  font-size: 1.6rem;
}
.btn{
  display: flex;
  justify-content: space-around;
}
ul{
  padding: 1rem;
}
li{
  border-bottom: 0.1rem solid rgb(230,230,230);
  padding: 0.8rem 0;
  overflow-x: scroll;
}
#mainBox{
  position: relative;
  /*overflow: hidden;*/
  padding-bottom: 100px;
}
#main,#grids{
  position: absolute;
  top: 0;
  left: 0;
}
#grids{
  z-index: 0;
}
#main{
  z-index: 100;
  position: relative;
}
#ruler{
  width: 1px;
  background: #000;
  position: absolute;
  left: 10px;
  z-index: 10;
}
#ruler::after{
  content: "1mv";
  font-size: 12px;
  position: absolute;
  top: -3px;
  left: 5px;
}
#bgbox{
  height: 300px;
  /*overflow: hidden;*/
}
#mainBox,#main,#grids{
  width: 100%;
}
</style>
